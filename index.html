<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Red Pilar - Tema Matrix</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #000;
            color: #0f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #0f0;
            box-shadow: 0 0 15px #0f0;
            position: relative;
            overflow: hidden;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo {
            width: 150px;
            height: auto;
            filter: invert(1);
        }
        h1 {
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #0f0;
        }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 4px;
            font-size: 16px;
            background-color: #000;
            color: #0f0;
        }
        #numbers-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
            background-color: #050505;
        }
        .number-box {
            background-color: #111;
            border: 1px solid #0a0;
            color: #0f0;
            text-align: center;
            padding: 8px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
        }
        .number-box:hover {
            background-color: #0f0;
            color: #000;
        }
        .number-box.selected {
            background-color: #0f0;
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 10px #0f0;
        }
        .number-box.assigned {
            background-color: #080808;
            color: #050;
            text-decoration: line-through;
            text-decoration-color: #050;
            cursor: not-allowed;
        }
        .button-group, .add-numbers-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .add-numbers-group {
            margin-top: 10px;
        }
        .range-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            border: 1px solid #0f0;
            border-radius: 4px;
            background-color: #000;
            color: #0f0;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex-grow: 1;
            margin: 0 5px;
            font-weight: bold;
        }
        button:hover {
            background-color: #0f0;
            color: #000;
        }
        button:first-child { margin-left: 0; }
        button:last-child { margin-right: 0; }
        #results-container {
            margin-top: 30px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            border: 1px solid #0f0;
        }
        .person-entry {
            border-bottom: 1px solid #0f0;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .person-entry:last-child {
            border-bottom: none;
        }
        .person-info {
            flex-grow: 1;
        }
        .person-name {
            font-weight: bold;
            color: #0f0;
            margin-bottom: 5px;
        }
        .person-numbers {
            font-size: 14px;
        }
        .person-actions {
            margin-left: 10px;
        }
        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
            color: #0f0;
        }
        .action-button:hover {
            color: #fff;
        }
        #ganador-container {
            margin-top: 20px;
            text-align: center;
            position: relative;
        }
        #ganador-container h2 {
            color: #0f0;
        }

        #animation-container {
            position: relative;
            height: 150px;
            margin-bottom: 20px;
            border: 1px dashed #0f0;
            overflow: hidden;
        }

        .animated-number {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #0f0;
            color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50%;
            box-shadow: 0 0 10px #0f0;
            animation-name: shuffle, spin;
            animation-duration: 0.5s, 1s;
            animation-iteration-count: infinite, infinite;
            animation-timing-function: linear, linear;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shuffle {
            0% { top: 50px; left: 50px; }
            25% { top: 0px; left: 200px; }
            50% { top: 100px; left: 100px; }
            75% { top: 50px; left: 0px; }
            100% { top: 50px; left: 250px; }
        }
        #ganador-nombre, #ganador-numero {
            font-size: 2em;
            font-weight: bold;
            color: #0f0;
            min-height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ganador-zoom {
            animation: winnerZoom 1s ease-in-out;
        }
        @keyframes winnerZoom {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        #countdown-timer {
            font-size: 3em;
            font-weight: bold;
            color: #0f0;
            margin-top: 20px;
        }
        .confetti {
            width: 10px;
            height: 10px;
            background-color: #f06;
            position: absolute;
            top: -10px;
            border-radius: 50%;
            z-index: 1;
            animation-name: fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        @keyframes fall {
            to {
                top: 105%;
                transform: translate(-50%, 0) rotateZ(360deg);
                opacity: 0;
            }
        }
        .number-box.resaltado {
            border: 3px solid #ff5722;
            transform: scale(1.1);
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #0f0;
        }
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (min-width: 768px) {
            .container {
                max-width: 900px;
            }
            #numbers-container {
                grid-template-columns: repeat(15, 1fr);
            }
        }

        /* --- ESTILOS PARA EL MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #0f0;
            box-shadow: 0 0 20px #0f0;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #0f0;
        }
        .modal-content .form-group {
            margin-bottom: 20px;
        }
        .modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 4px;
            font-size: 16px;
            background-color: #000;
            color: #0f0;
        }
        .modal-content .button-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        .modal-content .button-group button {
            width: auto;
            flex-grow: 0;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <canvas id="matrix-canvas"></canvas>
    <div class="container">
        <div class="logo-container">
            <img src="logo.png" alt="Logo de CeluApuestas" class="logo">
        </div>
        <h1 id="main-title">Sorteo Red Pilar</h1>
        <div id="form-container">
            <div class="form-group">
                <label for="person-name">Nombre del Participante:</label>
                <input type="text" id="person-name" placeholder="Escribe el nombre aquÃ­">
            </div>
            <div class="form-group">
                <label>Selecciona los nÃºmeros:</label>
                <div id="numbers-container"></div>
            </div>
            <div class="add-numbers-group">
                <button id="add-10-button">+10</button>
                <button id="add-25-button">+25</button>
                <button id="add-50-button">+50</button>
            </div>
            <div class="range-controls">
                <button id="add-range-button">+10 NÃºmeros</button>
                <button id="remove-range-button">-10 NÃºmeros</button>
            </div>
            <div class="button-group">
                <button id="add-button">AÃ±adir Participante</button>
                <button id="clear-button">Limpiar SelecciÃ³n</button>
            </div>
        </div>
        
        <div id="results-container">
            <h2>Participantes</h2>
            <div id="participants-list"></div>
        </div>
        
        <div class="button-group">
            <button id="sorteo-button">Realizar Sorteo</button>
            <button id="delete-unsold-button">Eliminar Libres</button>
            <button id="save-data-button">Guardar Datos</button>
            <button id="load-data-button">Cargar Datos</button>
        </div>

        <div id="save-code-container" style="display: none;">
            <h4>CÃ³digo de guardado:</h4>
            <span id="saved-code"></span>
        </div>
        
        <div id="ganador-container">
            <h2>ð Ganador del Sorteo ð</h2>
            <div id="animation-container"></div>
            <div id="ganador-numero"></div>
            <div id="ganador-nombre"></div>
            <div id="countdown-timer"></div>
        </div>
        
        <p class="footer">
            <a href="https://www.celuapuestas.ink" target="_blank" style="color: #0f0;">CELUAPUESTAS</a> - RED PILAR - design by Clau Admin Calopsita
        </p>
    </div>

    <!-- Modal para gestionar nÃºmero libre -->
    <div id="free-number-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title">Gestionar NÃºmero #<span id="modal-number"></span></h3>
            <div class="form-group">
                <label for="assign-to-participant-select">Asignar a un participante existente:</label>
                <select id="assign-to-participant-select">
                    <!-- Opciones se llenarÃ¡n con JS -->
                </select>
            </div>
            <div class="button-group">
                <button id="modal-assign-button">Asignar</button>
                <button id="modal-delete-button">Eliminar NÃºmero</button>
                <button id="modal-cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.20.0/matter.min.js"></script>
    <script>
        const personNameInput = document.getElementById('person-name');
        const numbersContainer = document.getElementById('numbers-container');
        const addButton = document.getElementById('add-button');
        const clearButton = document.getElementById('clear-button');
        const sorteoButton = document.getElementById('sorteo-button');
        const participantsList = document.getElementById('participants-list');
        const ganadorNombre = document.getElementById('ganador-nombre');
        const ganadorNumero = document.getElementById('ganador-numero');
        const countdownTimer = document.getElementById('countdown-timer');
        const animationContainer = document.getElementById('animation-container');
        const add10Button = document.getElementById('add-10-button');
        const add25Button = document.getElementById('add-25-button');
        const add50Button = document.getElementById('add-50-button');
        const addRangeButton = document.getElementById('add-range-button');
        const removeRangeButton = document.getElementById('remove-range-button');
        const saveDataButton = document.getElementById('save-data-button');
        const loadDataButton = document.getElementById('load-data-button');
        const savedCodeSpan = document.getElementById('saved-code');
        const deleteUnsoldButton = document.getElementById('delete-unsold-button');
        
        // Modal Elements
        const freeNumberModal = document.getElementById('free-number-modal');
        const modalNumberSpan = document.getElementById('modal-number');
        const assignToParticipantSelect = document.getElementById('assign-to-participant-select');
        const modalAssignButton = document.getElementById('modal-assign-button');
        const modalDeleteButton = document.getElementById('modal-delete-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');

        let currentNumberInModal = null;
        let allNumbers = [];
        let assignedNumbers = new Set();
        let selectedNumbers = new Set();
        let participants = [];
        
        let isEditing = false;
        let editingIndex = -1;
        let isLoading = false;

        // --- LÃ³gica del Sorteo ---
        function generateNumbers(count = 100) {
            allNumbers = Array.from({ length: count }, (_, i) => i + 1);
            renderNumbers();
        }

        function addMoreNumbers(count) {
            const currentMax = allNumbers.length > 0 ? allNumbers[allNumbers.length - 1] : 0;
            for (let i = 1; i <= count; i++) {
                allNumbers.push(currentMax + i);
            }
            renderNumbers();
            saveToLocalStorage();
        }

        function removeNumbers(count) {
            if (allNumbers.length <= 10) {
                alert("No se pueden eliminar mÃ¡s nÃºmeros. Debe haber al menos 10 nÃºmeros disponibles.");
                return;
            }
            
            // Verificar que no estamos eliminando nÃºmeros asignados
            const numbersToRemove = allNumbers.slice(-count);
            const hasAssignedNumbers = numbersToRemove.some(num => assignedNumbers.has(num));
            
            if (hasAssignedNumbers) {
                alert("No se pueden eliminar nÃºmeros que ya estÃ¡n asignados a participantes.");
                return;
            }
            
            // Eliminar los Ãºltimos 'count' nÃºmeros
            allNumbers = allNumbers.slice(0, -count);
            renderNumbers();
            saveToLocalStorage();
        }

        function openFreeNumberModal(number) {
            currentNumberInModal = number;
            modalNumberSpan.textContent = number;
            populateParticipantsDropdown();
            freeNumberModal.style.display = 'flex';
        }

        function closeFreeNumberModal() {
            currentNumberInModal = null;
            freeNumberModal.style.display = 'none';
        }

        function deleteSingleNumber() {
            if (currentNumberInModal === null) return;

            if (confirm(`Â¿EstÃ¡s seguro de que quieres eliminar el nÃºmero ${currentNumberInModal}? Esta acciÃ³n no se puede deshacer.`)) {
                const numberToDelete = currentNumberInModal;

                allNumbers = allNumbers.filter(num => num !== numberToDelete);
                assignedNumbers.delete(numberToDelete);
                selectedNumbers.delete(numberToDelete);

                renderNumbers();
                saveToLocalStorage();
                closeFreeNumberModal();
                alert(`El nÃºmero ${numberToDelete} ha sido eliminado.`);
            }
        }

        function populateParticipantsDropdown() {
            assignToParticipantSelect.innerHTML = '';

            if (participants.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No hay participantes todavÃ­a';
                option.disabled = true;
                assignToParticipantSelect.appendChild(option);
                modalAssignButton.disabled = true;
            } else {
                const placeholder = document.createElement('option');
                placeholder.textContent = 'Selecciona un participante...';
                placeholder.value = '';
                assignToParticipantSelect.appendChild(placeholder);

                participants.forEach((person, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = person.name;
                    assignToParticipantSelect.appendChild(option);
                });
                modalAssignButton.disabled = false;
            }
        }

        function assignNumberToParticipant() {
            const selectedParticipantIndex = assignToParticipantSelect.value;

            if (selectedParticipantIndex === '' || currentNumberInModal === null) {
                alert('Por favor, selecciona un participante.');
                return;
            }

            const participant = participants[selectedParticipantIndex];
            const numberToAssign = currentNumberInModal;

            participant.numbers.push(numberToAssign);
            participant.numbers.sort((a, b) => a - b);
            assignedNumbers.add(numberToAssign);

            renderNumbers();
            renderParticipants();
            saveToLocalStorage();
            closeFreeNumberModal();

            alert(`El nÃºmero ${numberToAssign} ha sido asignado a ${participant.name}.`);
        }

        function renderNumbers() {
            numbersContainer.innerHTML = '';
            allNumbers.forEach(num => {
                const numberBox = document.createElement('div');
                numberBox.classList.add('number-box');
                numberBox.textContent = num;
                numberBox.dataset.number = num;

                if (assignedNumbers.has(num)) {
                    numberBox.classList.add('assigned');
                }
                if (selectedNumbers.has(num)) {
                    numberBox.classList.add('selected');
                }

                numberBox.addEventListener('click', () => {
                    if (assignedNumbers.has(num)) {
                        return;
                    }

                    const isAddingParticipant = personNameInput.value.trim() !== '';

                    if (isAddingParticipant) {
                        if (selectedNumbers.has(num)) {
                            selectedNumbers.delete(num);
                            numberBox.classList.remove('selected');
                        } else {
                            selectedNumbers.add(num);
                            numberBox.classList.add('selected');
                        }
                    } else {
                        if (selectedNumbers.has(num)) {
                            selectedNumbers.delete(num);
                            numberBox.classList.remove('selected');
                        }
                        openFreeNumberModal(num);
                    }
                });
                numbersContainer.appendChild(numberBox);
            });
        }

        function addParticipant() {
            const name = personNameInput.value.trim();
            if (name === '') {
                alert('Por favor, introduce un nombre.');
                return;
            }

            selectedNumbers.clear();
            const selectedBoxes = numbersContainer.querySelectorAll('.number-box.selected');
            selectedBoxes.forEach(box => {
                selectedNumbers.add(parseInt(box.dataset.number, 10));
            });

            if (selectedNumbers.size === 0) {
                alert('Por favor, selecciona al menos un nÃºmero.');
                return;
            }

            const newParticipant = {
                name: name,
                numbers: Array.from(selectedNumbers).sort((a, b) => a - b)
            };

            if (isEditing) {
                const oldNumbers = participants[editingIndex].numbers;
                oldNumbers.forEach(num => assignedNumbers.delete(num));
                participants[editingIndex] = newParticipant;
                isEditing = false;
                editingIndex = -1;
                addButton.textContent = 'AÃ±adir Participante';
            } else {
                participants.push(newParticipant);
            }

            selectedNumbers.forEach(num => assignedNumbers.add(num));
            
            personNameInput.value = '';
            selectedNumbers.clear();
            
            renderNumbers();
            renderParticipants();
            saveToLocalStorage();
        }

        function renderParticipants() {
            participantsList.innerHTML = '';
            participants.forEach((person, index) => {
                const personEntry = document.createElement('div');
                personEntry.classList.add('person-entry');

                const personInfo = document.createElement('div');
                personInfo.classList.add('person-info');
                personInfo.innerHTML = `
                    <div class="person-name">${person.name}</div>
                    <div class="person-numbers">NÃºmeros: ${person.numbers.join(', ')}</div>
                `;
                personEntry.appendChild(personInfo);

                const personActions = document.createElement('div');
                personActions.classList.add('person-actions');
                
                const editButton = document.createElement('button');
                editButton.innerHTML = 'âï¸';
                editButton.classList.add('action-button');
                editButton.title = 'Editar';
                editButton.addEventListener('click', () => editParticipant(index));
                personActions.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = 'ðï¸';
                deleteButton.classList.add('action-button');
                deleteButton.title = 'Eliminar';
                deleteButton.addEventListener('click', () => deleteParticipant(index));
                personActions.appendChild(deleteButton);

                personEntry.appendChild(personActions);
                participantsList.appendChild(personEntry);
            });
        }

        function editParticipant(index) {
            const personToEdit = participants[index];
            personNameInput.value = personToEdit.name;
            selectedNumbers.clear();
            personToEdit.numbers.forEach(num => selectedNumbers.add(num));
            renderNumbers();
            
            isEditing = true;
            editingIndex = index;
            addButton.textContent = 'Actualizar Participante';
        }

        function deleteParticipant(index) {
            if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar a este participante?')) {
                const personToDelete = participants[index];
                personToDelete.numbers.forEach(num => assignedNumbers.delete(num));
                participants.splice(index, 1);
                
                renderNumbers();
                renderParticipants();
                saveToLocalStorage();
            }
        }

        function clearSelection() {
            selectedNumbers.clear();
            renderNumbers();
        }

        function selectRange(count) {
            selectedNumbers.clear();
            const unassignedNumbers = allNumbers.filter(num => !assignedNumbers.has(num));
            for (let i = 0; i < Math.min(count, unassignedNumbers.length); i++) {
                selectedNumbers.add(unassignedNumbers[i]);
            }
            renderNumbers();
        }

        async function realizarSorteo() {
            if (participants.length === 0) {
                alert('No hay participantes para el sorteo.');
                return;
            }
            
            const allAssignedNumbers = Array.from(assignedNumbers);
            if (allAssignedNumbers.length === 0) {
                alert('No hay nÃºmeros asignados para sortear.');
                return;
            }

            sorteoButton.disabled = true;
            clearButton.disabled = true;

            ganadorNombre.textContent = '';
            ganadorNumero.textContent = '';
            countdownTimer.style.display = 'block';

            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdownTimer.textContent = countdown;
                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.style.display = 'none';
                    startAnimation(allAssignedNumbers);
                }
                countdown--;
            }, 1000);
        }

        function startAnimation(numbersPool) {
            animationContainer.innerHTML = ''; // Clear previous animations

            const finalWinnerNumber = numbersPool[Math.floor(Math.random() * numbersPool.length)];
            const animationDuration = 7000; // 7 seconds
            const containerWidth = animationContainer.offsetWidth;
            const containerHeight = animationContainer.offsetHeight;

            // module aliases
            var Engine = Matter.Engine,
                Render = Matter.Render,
                Runner = Matter.Runner,
                Events = Matter.Events,
                Body = Matter.Body,
                Bodies = Matter.Bodies,
                Composite = Matter.Composite;

            // create an engine
            var engine = Engine.create();
            engine.world.gravity.y = 0; // No gravity

            // create a renderer
            var render = Render.create({
                element: animationContainer,
                engine: engine,
                options: {
                    width: containerWidth,
                    height: containerHeight,
                    wireframes: false, // We want to see the colors
                    background: 'transparent'
                }
            });

            // Create boundaries
            const wallOptions = { isStatic: true, render: { visible: false } };
            Composite.add(engine.world, [
                Bodies.rectangle(containerWidth / 2, 5, containerWidth, 10, wallOptions), // Top
                Bodies.rectangle(containerWidth / 2, containerHeight - 5, containerWidth, 10, wallOptions), // Bottom
                Bodies.rectangle(5, containerHeight / 2, 10, containerHeight, wallOptions), // Left
                Bodies.rectangle(containerWidth - 5, containerHeight / 2, 10, containerHeight, wallOptions) // Right
            ]);

            // Helper function to create a texture with the number
            function createBallTexture(number) {
                const canvas = document.createElement('canvas');
                canvas.width = 50;
                canvas.height = 50;
                const context = canvas.getContext('2d');
                context.beginPath();
                context.arc(25, 25, 25, 0, 2 * Math.PI);
                context.fillStyle = '#0f0'; // Green ball
                context.fill();
                context.fillStyle = '#000'; // Black text
                context.font = 'bold 24px "Courier New"';
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(number, 25, 25);
                return canvas.toDataURL();
            }

            // Create balls
            const balls = [];
            const numBalls = Math.min(numbersPool.length, 30); // Limit to 30 balls for performance
            let usedNumbers = new Set();

            for (let i = 0; i < numBalls; i++) {
                let number;
                do {
                    number = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                } while (usedNumbers.has(number));
                usedNumbers.add(number);

                const ball = Bodies.circle(
                    Math.random() * (containerWidth - 60) + 30, // x
                    Math.random() * (containerHeight - 60) + 30, // y
                    25, // radius
                    {
                        restitution: 1, // bounciness
                        friction: 0,
                        frictionAir: 0,
                        render: {
                            sprite: {
                                texture: createBallTexture(number),
                                xScale: 1,
                                yScale: 1
                            }
                        }
                    }
                );
                // Give it a random initial velocity
                Body.setVelocity(ball, {
                    x: (Math.random() - 0.5) * 15,
                    y: (Math.random() - 0.5) * 15
                });
                balls.push(ball);
            }

            Composite.add(engine.world, balls);

            // Keep balls moving
            Events.on(engine, 'beforeUpdate', function(event) {
                for (var i = 0; i < balls.length; i++) {
                    var ball = balls[i];
                    // Apply a small random force
                    Body.applyForce(ball, ball.position, {
                        x: (Math.random() - 0.5) * 0.001,
                        y: (Math.random() - 0.5) * 0.001
                    });
                }
            });

            // run the renderer
            Render.run(render);

            // create runner
            var runner = Runner.create();

            // run the engine
            Runner.run(runner, engine);

            setTimeout(() => {
                // Stop the simulation
                Runner.stop(runner);
                Render.stop(render);
                Composite.clear(engine.world, false);
                Engine.clear(engine);
                if (render.canvas) {
                    render.canvas.remove();
                }

                showWinner(finalWinnerNumber);
            }, animationDuration);
        }

        function showWinner(winnerNumber) {
            const winner = participants.find(p => p.numbers.includes(winnerNumber));
            const winningPersonName = winner ? winner.name : 'Desconocido';

            ganadorNombre.textContent = winningPersonName;
            ganadorNumero.textContent = winnerNumber;
            
            ganadorNombre.classList.add('ganador-zoom');
            ganadorNumero.classList.add('ganador-zoom');

            setTimeout(() => {
                ganadorNombre.classList.remove('ganador-zoom');
                ganadorNumero.classList.remove('ganador-zoom');
            }, 1000);

            const winningNumberBox = document.querySelector(`.number-box[data-number="${winnerNumber}"]`);
            if (winningNumberBox) {
                winningNumberBox.classList.add('resaltado');
            }

            createConfetti();

            sorteoButton.disabled = false;
            clearButton.disabled = false;
            saveToLocalStorage();
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        function deleteUnassignedNumbers() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar todos los nÃºmeros libres? Esta acciÃ³n no se puede deshacer y solo conservarÃ¡ los nÃºmeros ya vendidos.')) {
                allNumbers = allNumbers.filter(num => assignedNumbers.has(num));
                renderNumbers();
                saveToLocalStorage();
                alert('Se han eliminado todos los nÃºmeros libres.');
            }
        }

        // --- Funcionalidad de Guardado y Carga ---
        function saveToLocalStorage() {
            const data = {
                participants: participants,
                assignedNumbers: Array.from(assignedNumbers),
                allNumbers: allNumbers
            };
            const compressedData = btoa(JSON.stringify(data));
            localStorage.setItem('raffleData', compressedData);
        }

        function loadFromLocalStorage() {
            const compressedData = localStorage.getItem('raffleData');
            if (compressedData) {
                try {
                    const decompressedData = JSON.parse(atob(compressedData));
                    participants = decompressedData.participants || [];
                    assignedNumbers = new Set(decompressedData.assignedNumbers || []);
                    allNumbers = decompressedData.allNumbers || [];

                    if (allNumbers.length === 0) {
                        generateNumbers(100);
                    } else {
                        renderNumbers();
                    }
                    renderParticipants();

                } catch (e) {
                    console.error("Error al analizar los datos de localStorage, reseteando. Error:", e);
                    localStorage.removeItem('raffleData');
                    generateNumbers(100);
                }
            } else {
                generateNumbers(100);
            }
        }

        function generateSaveCode() {
            const data = {
                participants: participants,
                assignedNumbers: Array.from(assignedNumbers)
            };
            const compressedData = btoa(JSON.stringify(data));
            savedCodeSpan.textContent = compressedData;
            document.getElementById('save-code-container').style.display = 'block';
        }

        function loadFromCode() {
            const code = prompt('Introduce el cÃ³digo de guardado:');
            if (code) {
                try {
                    const decompressedData = JSON.parse(atob(code));
                    participants = decompressedData.participants;
                    assignedNumbers = new Set(decompressedData.assignedNumbers);
                    
                    renderNumbers();
                    renderParticipants();
                } catch (e) {
                    alert('CÃ³digo invÃ¡lido.');
                }
            }
        }

        // --- LÃ³gica del Tema Matrix ---
        const matrixCanvas = document.getElementById('matrix-canvas');
        const matrixCtx = matrixCanvas.getContext('2d');
        let matrixAnimationInterval;

        function startMatrixAnimation() {
            if (matrixAnimationInterval) clearInterval(matrixAnimationInterval);

            matrixCanvas.width = window.innerWidth;
            matrixCanvas.height = window.innerHeight;

            const letters = '0123456789';
            const fontSize = 16;
            const columns = matrixCanvas.width / fontSize;

            const drops = [];
            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }

            function drawMatrix() {
                matrixCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);

                matrixCtx.fillStyle = '#0f0';
                matrixCtx.font = fontSize + 'px arial';

                for (let i = 0; i < drops.length; i++) {
                    const text = letters.charAt(Math.floor(Math.random() * letters.length));
                    matrixCtx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > matrixCanvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            matrixAnimationInterval = setInterval(drawMatrix, 33);
        }

        window.addEventListener('resize', () => {
            startMatrixAnimation();
        });

        // --- InicializaciÃ³n ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            startMatrixAnimation();
        });

        // --- Event Listeners ---
        addButton.addEventListener('click', addParticipant);
        clearButton.addEventListener('click', clearSelection);
        sorteoButton.addEventListener('click', realizarSorteo);
        add10Button.addEventListener('click', () => selectRange(10));
        add25Button.addEventListener('click', () => selectRange(25));
        add50Button.addEventListener('click', () => selectRange(50));
        addRangeButton.addEventListener('click', () => addMoreNumbers(10));
        removeRangeButton.addEventListener('click', () => removeNumbers(10));
        saveDataButton.addEventListener('click', generateSaveCode);
        loadDataButton.addEventListener('click', loadFromCode);
        deleteUnsoldButton.addEventListener('click', deleteUnassignedNumbers);
        modalCancelButton.addEventListener('click', closeFreeNumberModal);
        modalDeleteButton.addEventListener('click', deleteSingleNumber);
        modalAssignButton.addEventListener('click', assignNumberToParticipant);

    </script>
</body>
</html>
